pipeline {
        agent {
            ecs {
                inheritFrom 'ecs'
            }
        }
  environment {
    BUILD_TAG = "${env.BUILD_TAG}"
  }

  options {
    timeout(time: 20, unit: 'MINUTES')
    skipDefaultCheckout true
  }

  stages {  
    stage('Checkout') {

      steps {
        checkout scm
      }
    }
  
    stage('Build') {
      steps {
        sh "./scripts/gradle_build.sh"
        stash includes: 'app/build/libs/**/*.jar', name: 'jar' 
        stash includes: 'docker-images/spring-boot-web-app/Dockerfile', name: 'docker'
      }
    }

    stage('Build docker image') {
    agent any
      steps {
      unstash 'jar'
      unstash 'docker'
      sh '''
        cp docker-images/spring-boot-web-app/Dockerfile app/build/libs
        cd app/build/libs
        docker build -t webapp:$BUILD_TAG .
      '''
      }

    }

  stage('Deploy to K8S') {
        when {
                branch 'production'
            }
      steps {
        withCredentials([usernamePassword(credentialsId: 'aws_pwd', usernameVariable: 'AWS_ACCESS_KEY_ID', passwordVariable: 'AWS_SECRET_ACCESS_KEY')]) {
          withEnv(['KUBECONFIG=/home/ubuntu/.kube/config', 'AWS_CONFIG_FILE=/home/ubuntu/.aws/config']){
            sh '''
            #!/bin/bash
            echo "The location of kubeconfig is $KUBECONFIG"
            # Update kube config
            aws eks --region eu-north-1 update-kubeconfig --name ruiyang_master_thesis --kubeconfig $KUBECONFIG
            kubectl apply -f k8s/yaml/deployment.yaml
          '''
          }
        }
      }
    }
    }

  }
