pipeline {
          agent {
            ecs {
                inheritFrom 'ecs'
            }
        }
  environment {
    BUILD_TAG = "${env.BUILD_TAG}"
  }

  options {
    timeout(time: 20, unit: 'MINUTES')
  }

  stages {
    stage('Checkout') {
      steps {
        checkout scm
        // stash(excludes: '.git', name: 'code')
      }
    }
  
    stage('Build') {

      steps {
      // Build, TODO: change Docker to something else
      // unstash 'code'
        sh "./scripts/gradle_build.sh"
      }
    }

  stage('Deploy to K8S') {
        when {
                branch 'production'
            }
      steps {
        withCredentials([usernamePassword(credentialsId: 'aws_pwd', usernameVariable: 'AWS_ACCESS_KEY_ID', passwordVariable: 'AWS_SECRET_ACCESS_KEY')]) {
          withEnv(['KUBECONFIG=/home/ubuntu/.kube/config', 'AWS_CONFIG_FILE=/home/ubuntu/.aws/config']){
            sh '''
            #!/bin/bash
            echo "The location of kubeconfig is $KUBECONFIG"
            # Update kube config
            aws eks --region eu-north-1 update-kubeconfig --name ruiyang_master_thesis --kubeconfig $KUBECONFIG
            kubectl apply -f k8s/yaml/deployment.yaml
          '''
          }
        }
      }
    }
    }

   post {
        always {
            archiveArtifacts artifacts: 'app/build/libs/**/*.jar', fingerprint: true
        }
    }
  }
